# 资源合并与压缩

## 1 优化思路

web 前端是 BS 架构。

BS 架构就是，前端代码开发完成后，将代码发布到远程服务器。然后用户通过浏览器输入网址，这时浏览器向远程服务器发出请求，动态的加载页面的资源。

因此 web 前端的访问过程是一个动态、增量的加载资源的过程。如果浏览器能越快的获取资源，那么用户就能越快的看到页面，体验也就越好。这是前端性能优化很重要的一个点。

从资源加载方面优化，需要先分析一下，浏览器的一个请求从发送到返回都经历了什么？

![](../../images/1_resource_20191117164149.png)

上图是一个 http 请求发出到响应的过程，在这个过程中可以去挖掘一些可以优化的点，去实现前端的性能优化。

请求过程中一些潜在的性能优化点：

- dns 是否可以通过缓存减少 dns 查询时间
- 网络请求的过程中是否可以走最近的网络环境
- 相同的静态资源是否可以缓存
- 能否减少 http 请求大小
- 减少 http 请求
- 服务端渲染

## 2 优化点

资源合并与压缩涉及到的优化点主要有两个，一个是减少 http 请求数量，另外是减少请求资源的大小

具体的优化点如下：

- html 压缩
- css 压缩
- js 的压缩和混乱
- 文件合并
- 开启 gzip

## 3 html 压缩

html 代码压缩就是压缩这些在文本文件中有意义，但是在 html 中不显示的字符，包括空格、制表符、换行符等，还有一些其他无意义的字符，如 html 注释也可以被压缩

## 4 css 压缩

- 无效代码删除（空格、换行、注释等）
- css 语义合并（重复的代码）

## 5 js 压缩与混乱

- 无效字符的删除
- 删除注释
- 代码语义的缩减和优化（缩短变量名的长度，删除重复代码等）
- 代码保护（js 的代码是透明的，压缩和混淆后可以降低代码的可读性）

js 和 css 代码压缩不仅能减少文件大小，还有有网站安全方面的收益。并且 js 和 css 的压缩率是比较高的，可以很大程度的减少文件的大小

## 6 文件合并

合并文件可以减少 http 请求的数量。

请求多个 js 文件跟请求一个 js 文件相比：

- 文件与文件之间有插入的上行请求，增加了 N-1 个网络延迟
- 受丢包的影响更严重（请求数量更多，丢包的概率更大）

当然合并文件也不是万能的，合并文件也有它的缺点：

- 首屏渲染问题
- 缓存失效问题

文件合并后自然单个文件会变得更大。如果网站是单页面应用，合并文件通常会把公共库还有其他页面的 js 都打包在一起，而首屏渲染需要等待这些资源都加载完成。其中很多资源是首屏页面不需要的。

缓存失效问题，合并文件会造成大面积的缓存失效。通常当一个文件有改动时才需要重新加载。如果将几个文件合并的话，其中一个文件有改动，那么合并后的文件也会改动，这时就需要重新加载整个文件。而未合并的话只需要重新加载改动的文件就行。

**常用的文件合并策略：**

- 公共库合并（通常公共库会很少改动，将它们合并更不容易出现缓存失效问题）
- 分页面合并（也就是按需加载，不要将所有页面都打包到一起，而是将单个页面所依赖的资源打包，匹配到某个路由的时候只加载这个路由需要的资源）
